# https://aka.ms/yaml

env:
  LIBRARY_PATH: /lib:/usr/lib

jobs:
- job: test
  displayName: 'Lint & Test'

  pool:
    vmImage: 'Ubuntu 16.04'

  env:
    PIP_CACHE_DIR: ".cache/pip"
    PIP_SRC: ".cache/src"

  steps:
  - task: UsePythonVersion@0
    displayName: 'Set Python version'
    inputs:
      versionSpec: '3.7.x'
      addToPath: true

  - script: |
      set -o pipefail
      curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py | python3 - -y
    displayName: 'Install Poetry'

  - script: |
      ~/.poetry/bin/poetry config settings.virtualenvs.create false
      ~/.poetry/bin/poetry install
    displayName: 'Install project using Poetry'

  - script: python3 -m flake8
    displayName: 'Run linter'

- job: build
  displayName: 'Build Containers'
  dependsOn: 'test'

  steps:
  - task: Docker@1
    displayName: 'Login: Docker Hub'

    inputs:
      containerregistrytype: 'Container Registry'
      dockerRegistryEndpoint: 'DockerHub'
      command: 'login'

  - task: ShellScript@2
    displayName: 'Build and deploy containers'

    inputs:
      scriptPath: scripts/deploy-azure.sh
